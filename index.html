<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi & Jam Kerja</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: clamp(20px, 4vw, 28px);
            margin-bottom: 8px;
        }

        .header p {
            font-size: clamp(12px, 3vw, 14px);
            opacity: 0.9;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert-error {
            background: #fdecea;
            border-color: #d93025;
            color: #d93025;
        }

        .alert-success {
            background: #e6f4ea;
            border-color: #0f9d58;
            color: #0f9d58;
        }

        /* Toast Notification Slide-in dari Kanan */
        .toast {
            position: fixed;
            top: 20px;
            right: -400px;
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            right: 20px;
        }

        .toast-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #F44336 0%, #d32f2f 100%);
            color: white;
        }

        .toast-icon {
            font-size: 24px;
            animation: bounceIn 0.6s;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .period-info {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            border: 2px solid #667eea30;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: clamp(24px, 5vw, 32px);
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .stat-card.clean .value {
            font-size: clamp(18px, 4vw, 24px);
        }

        .stat-card .label {
            font-size: 12px;
            color: #999;
        }

        .stat-card.elapsed .value {
            color: #2196F3;
        }

        .stat-card.clean .value {
            color: #4CAF50;
        }

        .stat-card.remaining .value {
            color: #FF9800;
        }

        .stat-card.shortfall .value {
            color: #F44336;
        }

        .stat-card.overtime .value {
            color: #9C27B0;
        }

        .stat-card.absent .value {
            color: #607D8B;
        }

        .legend {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .legend-icon {
            font-size: 20px;
            min-width: 24px;
        }

        .legend-text {
            font-size: 13px;
            line-height: 1.5;
            color: #555;
        }

        .calendar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            font-size: clamp(16px, 4vw, 20px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .day-cell {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            min-height: 150px;
            background: white;
            transition: all 0.2s;
        }

        .day-cell:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .day-cell.sunday {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .day-cell.saturday {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .day-number {
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            padding: 8px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .day-name {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-bottom: 10px;
        }

        .attendance-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .attendance-btn:active {
            transform: scale(0.95);
        }

        .attendance-btn.hadir {
            background: #4CAF50;
            color: white;
        }

        .attendance-btn.tidak-hadir {
            background: #F44336;
            color: white;
        }

        .attendance-btn.none {
            background: #e0e0e0;
            color: #666;
        }

        .input-small {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            margin-top: 5px;
        }

        .input-label {
            font-size: 10px;
            color: #999;
            text-align: center;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .overtime-input {
            background: #FFF9C4;
            border-color: #FDD835;
        }

        .hours-input {
            background: #E8F5E9;
            border-color: #66BB6A;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin-top: 5px;
        }

        .preset-btn {
            padding: 6px 4px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #1976D2;
        }

        .preset-btn:hover {
            background: #2196F3;
            color: white;
            transform: scale(1.05);
        }

        .preset-btn:active {
            transform: scale(0.95);
        }

        .hint-text {
            font-size: 10px;
            color: #999;
            text-align: center;
            margin-top: 3px;
            font-style: italic;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }

        .tab-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .summary-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .summary-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
        }

        .summary-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .summary-table tr:hover {
            background: #f9f9f9;
        }

        .summary-table .number {
            text-align: center;
            font-weight: 600;
        }

        .summary-table .good {
            color: #4CAF50;
        }

        .summary-table .warning {
            color: #FF9800;
        }

        .summary-table .bad {
            color: #F44336;
        }

        .loading,
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .loading h3,
        .empty-state h2 {
            font-size: clamp(24px, 6vw, 36px);
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .day-cell {
                min-height: 140px;
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä Sistem Absensi Karyawan</h1>
            <p>Lembur diakumulasi ke jam kerja normal sampai terpenuhi</p>
        </div>

        <div id="errorAlert" class="alert alert-error" style="display: none;"></div>
        <div id="successAlert" class="alert alert-success" style="display: none;"></div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <!-- Tab Navigation -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="tabInput" class="tab-btn active" onclick="switchTab('input')">
                üìù Input Absensi
            </button>
            <button id="tabSummary" class="tab-btn" onclick="switchTab('summary')">
                üìä Rangkuman Semua Karyawan
            </button>
        </div>

        <!-- Panduan Singkat -->
        <div id="guideBox"
            style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <h3 style="margin-bottom: 10px; font-size: 16px; color: #856404;">üìã Cara Menggunakan (3 Langkah Mudah)</h3>
            <ol style="margin: 0; padding-left: 20px; color: #856404; font-size: 14px; line-height: 1.8;">
                <li><strong>Pilih nama karyawan</strong>, bulan, dan tahun</li>
                <li><strong>Klik tombol "Muat Data Absensi"</strong></li>
                <li><strong>Isi kehadiran</strong> dengan klik tombol ‚úì (Hadir) atau ‚úó (Tidak Hadir) di setiap tanggal
                </li>
            </ol>
        </div>

        <div class="controls">
            <div class="form-group">
                <label for="employeeSelect">üë§ Pilih Karyawan</label>
                <select id="employeeSelect">
                    <option value="">-- Pilih Karyawan --</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="monthSelect">üìÖ Bulan</label>
                    <select id="monthSelect">
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="yearSelect">üìÜ Tahun</label>
                    <select id="yearSelect">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>

            <button class="btn-primary" onclick="loadEmployee()">
                üöÄ Muat Data Absensi
            </button>
        </div>

        <!-- Summary Page -->
        <div id="summaryContainer" style="display: none;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="summaryMonth">üìÖ Bulan</label>
                    <select id="summaryMonth">
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="summaryYear">üìÜ Tahun</label>
                    <select id="summaryYear">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>
            <button class="btn-primary" onclick="loadSummary()">
                üìä Muat Rangkuman
            </button>
            <div id="summaryTable" style="margin-top: 20px;"></div>
        </div>

        <div id="statsContainer" style="display: none;">
            <div class="period-info" id="periodInfo">Loading...</div>

            <div class="stats-grid">
                <div class="stat-card elapsed">
                    <h3>Hari Kerja Berlalu</h3>
                    <div class="value" id="statElapsed">0</div>
                    <div class="label">hari</div>
                </div>

                <div class="stat-card clean">
                    <h3>Hari Kerja Bersih</h3>
                    <div class="value" id="statClean" style="font-size: 24px;">0</div>
                    <div class="label">hari terpenuhi</div>
                </div>

                <div class="stat-card remaining" id="cardRemaining">
                    <h3>Sisa Jam</h3>
                    <div class="value" id="statRemaining">0</div>
                    <div class="label">jam tersisa</div>
                </div>

                <div class="stat-card shortfall">
                    <h3>Kekurangan</h3>
                    <div class="value" id="statShortfall" style="font-size: 24px;">0</div>
                    <div class="label">hari</div>
                </div>

                <div class="stat-card overtime" id="cardOvertime">
                    <h3>Lembur Bersih</h3>
                    <div class="value" id="statOvertime">0</div>
                    <div class="label">jam</div>
                </div>

                <div class="stat-card absent">
                    <h3>Tidak Hadir</h3>
                    <div class="value" id="statAbsent">0</div>
                    <div class="label">hari</div>
                </div>
            </div>

            <div class="legend">
                <h3>üìñ Penjelasan Kartu (Bahasa Sederhana)</h3>

                <div class="legend-item">
                    <div class="legend-icon">üìÜ</div>
                    <div class="legend-text">
                        <strong>Hari Kerja Berlalu:</strong> Berapa hari kerja yang sudah lewat (Senin-Sabtu saja, tidak
                        termasuk Minggu).
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-icon">‚úÖ</div>
                    <div class="legend-text">
                        <strong>Hari Kerja Bersih:</strong> Berapa hari kerja yang sudah terpenuhi penuh. Jika kurang
                        dari target, lembur bisa menutup kekurangan.
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-icon">‚è∞</div>
                    <div class="legend-text">
                        <strong>Sisa Jam:</strong> Berapa jam lagi yang dibutuhkan untuk melengkapi 1 hari kerja penuh.
                        Kartu ini muncul jika masih ada kekurangan.
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-icon">‚ö†Ô∏è</div>
                    <div class="legend-text">
                        <strong>Kekurangan:</strong> Total hari dan jam yang masih kurang dari target. Contoh: "1 hari +
                        2.5 jam" artinya kurang 1 hari penuh dan 2.5 jam lagi.
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-icon">üéÅ</div>
                    <div class="legend-text">
                        <strong>Lembur Bersih:</strong> Jam lembur yang jadi bonus setelah semua target terpenuhi. Kartu
                        ini muncul jika tidak ada kekurangan lagi.
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-icon">‚ùå</div>
                    <div class="legend-text">
                        <strong>Tidak Hadir:</strong> Jumlah hari yang benar-benar tidak masuk (ditandai ‚úó). Masuk
                        setengah hari tidak dihitung tidak hadir.
                    </div>
                </div>
            </div>

            <div class="calendar">
                <h2 id="calendarTitle">üìÖ Kalender Absensi</h2>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <h2>üëã</h2>
            <p>Silakan pilih karyawan dan periode,<br>lalu klik tombol "Muat Data Absensi"</p>
        </div>

        <div id="loadingState" class="loading" style="display: none;">
            <h3>‚è≥</h3>
            <p>Memuat data, harap tunggu...</p>
        </div>
    </div>

    <script>
        let currentEmployee = '';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let attendanceData = {};

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = 'toast toast-' + type;

            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div>${message}</div>
      `;

            // Slide in
            setTimeout(() => toast.classList.add('show'), 100);

            // Slide out
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        window.onload = function () {
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('summaryMonth').value = currentMonth;
            document.getElementById('summaryYear').value = currentYear;
            loadEmployees();
        };

        function switchTab(tab) {
            const tabInput = document.getElementById('tabInput');
            const tabSummary = document.getElementById('tabSummary');
            const guideBox = document.getElementById('guideBox');
            const controls = document.querySelector('.controls');
            const statsContainer = document.getElementById('statsContainer');
            const summaryContainer = document.getElementById('summaryContainer');
            const emptyState = document.getElementById('emptyState');

            if (tab === 'input') {
                tabInput.classList.add('active');
                tabSummary.classList.remove('active');
                guideBox.style.display = 'block';
                controls.style.display = 'block';
                summaryContainer.style.display = 'none';
                if (currentEmployee) {
                    statsContainer.style.display = 'block';
                    emptyState.style.display = 'none';
                } else {
                    statsContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                }
            } else {
                tabInput.classList.remove('active');
                tabSummary.classList.add('active');
                guideBox.style.display = 'none';
                controls.style.display = 'none';
                statsContainer.style.display = 'none';
                emptyState.style.display = 'none';
                summaryContainer.style.display = 'block';
            }
        }

        function loadSummary() {
            const month = parseInt(document.getElementById('summaryMonth').value);
            const year = parseInt(document.getElementById('summaryYear').value);

            document.getElementById('summaryTable').innerHTML = '<div class="loading"><h3>‚è≥</h3><p>Memuat rangkuman...</p></div>';

            google.script.run
                .withSuccessHandler(function (summary) {
                    renderSummaryTable(summary, month, year);
                })
                .withFailureHandler(function (error) {
                    showError('Gagal memuat rangkuman: ' + error.message);
                })
                .getAllEmployeesSummary(year, month);
        }

        function renderSummaryTable(summary, month, year) {
            const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            let html = `
                <div class="summary-table">
                    <h2 style="text-align: center; margin-bottom: 15px; color: #333;">
                        üìä Rangkuman ${monthNames[month]} ${year}
                    </h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Nama Karyawan</th>
                                <th class="number">Hari Berlalu</th>
                                <th class="number">Hari Bersih</th>
                                <th class="number">Sisa Jam</th>
                                <th class="number">Kekurangan</th>
                                <th class="number">Lembur Bersih</th>
                                <th class="number">Tidak Hadir</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            summary.forEach(emp => {
                const shortfallClass = parseFloat(emp.shortfallHours) > 0 ? 'bad' : 'good';
                const absentClass = emp.absentDays > 0 ? 'warning' : 'good';

                html += `
                    <tr>
                        <td><strong>${emp.name}</strong></td>
                        <td class="number">${emp.workDaysElapsed}</td>
                        <td class="number good">${emp.cleanWorkDays}</td>
                        <td class="number ${emp.isComplete ? 'good' : 'warning'}">${emp.isComplete ? '-' : emp.remainingHours}</td>
                        <td class="number ${shortfallClass}">${emp.shortfallDays}</td>
                        <td class="number ${emp.isComplete ? 'good' : ''}">${emp.isComplete ? emp.cleanOvertime : '-'}</td>
                        <td class="number ${absentClass}">${emp.absentDays}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('summaryTable').innerHTML = html;
        }

        function loadEmployees() {
            google.script.run
                .withSuccessHandler(function (employees) {
                    const select = document.getElementById('employeeSelect');
                    select.innerHTML = '<option value="">-- Pilih Karyawan --</option>';
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp;
                        option.textContent = emp;
                        select.appendChild(option);
                    });
                })
                .withFailureHandler(showError)
                .getEmployees();
        }

        function loadEmployee() {
            const employee = document.getElementById('employeeSelect').value;
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);

            if (!employee) {
                showError('Harap pilih karyawan terlebih dahulu!');
                return;
            }

            currentEmployee = employee;
            currentMonth = month;
            currentYear = year;

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'none';

            google.script.run
                .withSuccessHandler(function (data) {
                    // Pastikan data tidak null
                    attendanceData = data || {};
                    renderCalendar();
                    calculateStats();
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('statsContainer').style.display = 'block';
                })
                .withFailureHandler(function (error) {
                    showError('Gagal memuat data: ' + error.message);
                    document.getElementById('loadingState').style.display = 'none';
                })
                .getAttendanceData(employee, year, month);
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Pastikan attendanceData tidak null
            if (!attendanceData) {
                attendanceData = {};
            }

            const startDate = new Date(currentYear, currentMonth - 1, 2);
            const endDate = new Date(currentYear, currentMonth, 1);

            document.getElementById('calendarTitle').textContent =
                `üìÖ Kalender Absensi - ${currentEmployee}`;

            let currentDate = new Date(startDate);
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

            while (currentDate <= endDate) {
                const dateStr = formatDateString(currentDate);
                const dayOfWeek = currentDate.getDay();
                const dayData = attendanceData[dateStr] || {};

                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (dayOfWeek === 0) cell.classList.add('sunday');
                if (dayOfWeek === 6) cell.classList.add('saturday');

                const status = dayData.status !== null && dayData.status !== undefined ? dayData.status : '';
                const overtime = dayData.overtime || 0;

                let btnClass = 'none';
                let btnText = '-';

                if (status === 'HADIR') {
                    btnClass = 'hadir';
                    btnText = '‚úì';
                } else if (status === 'TIDAK_HADIR') {
                    btnClass = 'tidak-hadir';
                    btnText = '‚úó';
                }

                cell.innerHTML = `
          <div class="day-number">${currentDate.getDate()}</div>
          <div class="day-name">${dayNames[dayOfWeek]}</div>
          ${dayOfWeek !== 0 ? `
            <button class="attendance-btn ${btnClass}" onclick="toggleAttendance(${currentDate.getDate()})">
              ${btnText}
            </button>
            <div class="input-label">Jam Kerja</div>
            ${status !== 'HADIR' && status !== 'TIDAK_HADIR' ?
                            `<input type="number" step="0.5" min="0" max="12" class="input-small hours-input" 
                value="${status || ''}" placeholder="0" onchange="setPartialHours(${currentDate.getDate()}, this.value)" title="Isi jika masuk setengah hari (contoh: 4 untuk 4 jam)">
                <div class="hint-text">Kosongkan jika hadir penuh</div>` :
                            '<div style="text-align: center; font-size: 11px; color: #4CAF50; padding: 8px;">Hadir Penuh</div>'
                        }
          ` : '<div style="text-align: center; font-size: 13px; color: #F44336; padding: 12px; font-weight: 600;">LIBUR</div>'}
          <div class="input-label">Lembur (Jam)</div>
          <div class="preset-buttons">
            <button class="preset-btn" onclick="setOvertimePreset(${currentDate.getDate()}, 0.5)">0.5</button>
            <button class="preset-btn" onclick="setOvertimePreset(${currentDate.getDate()}, 1)">1</button>
            <button class="preset-btn" onclick="setOvertimePreset(${currentDate.getDate()}, 1.5)">1.5</button>
            <button class="preset-btn" onclick="setOvertimePreset(${currentDate.getDate()}, 2)">2</button>
          </div>
          <input type="number" step="0.5" min="0" class="input-small overtime-input" placeholder="0"
            value="${overtime || ''}" onchange="setOvertime(${currentDate.getDate()}, this.value)" id="overtime-${currentDate.getDate()}">
          <div class="hint-text">Klik tombol atau ketik manual</div>
        `;

                grid.appendChild(cell);
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        function toggleAttendance(day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const dateStr = formatDateString(date);
            const current = attendanceData[dateStr]?.status;
            const currentStatus = current !== null && current !== undefined ? current : '';

            let next = '';
            if (!currentStatus || (currentStatus !== 'HADIR' && currentStatus !== 'TIDAK_HADIR')) {
                next = 'HADIR';
            } else if (currentStatus === 'HADIR') {
                next = 'TIDAK_HADIR';
            } else {
                next = '';
            }

            saveData(day, 'status', next);
        }

        function setPartialHours(day, value) {
            if (!value || value === '') {
                saveData(day, 'status', '');
                return;
            }

            // Ganti koma dengan titik untuk format angka
            let cleanValue = String(value).replace(',', '.');

            // Validasi: harus angka valid
            const numValue = parseFloat(cleanValue);
            if (isNaN(numValue) || numValue < 0 || numValue > 12) {
                showError('Jam kerja harus angka antara 0-12');
                return;
            }

            // Simpan sebagai string angka (bukan Date)
            saveData(day, 'status', cleanValue);
        }

        function setOvertime(day, value) {
            if (!value || value === '') {
                saveData(day, 'overtime', 0);
                return;
            }

            // Ganti koma dengan titik untuk format angka
            let cleanValue = String(value).replace(',', '.');

            // Validasi: harus angka valid
            const numValue = parseFloat(cleanValue);
            if (isNaN(numValue) || numValue < 0) {
                showError('Jam lembur harus angka positif');
                return;
            }

            saveData(day, 'overtime', numValue);
        }

        function setOvertimePreset(day, value) {
            // Update input field
            const input = document.getElementById('overtime-' + day);
            if (input) {
                input.value = value;
            }
            saveData(day, 'overtime', value);
        }

        function saveData(day, type, value) {
            google.script.run
                .withSuccessHandler(function () {
                    const date = new Date(currentYear, currentMonth - 1, day);
                    const dateStr = formatDateString(date);
                    if (!attendanceData[dateStr]) attendanceData[dateStr] = {};
                    attendanceData[dateStr][type] = value;
                    renderCalendar();
                    calculateStats();
                    showSuccess('Data berhasil disimpan!');
                })
                .withFailureHandler(function (error) {
                    showError('Gagal menyimpan: ' + error.message);
                })
                .saveAttendance(currentEmployee, currentYear, currentMonth, day, type, value);
        }

        function calculateStats() {
            google.script.run
                .withSuccessHandler(function (stats) {
                    document.getElementById('statElapsed').textContent = stats.workDaysElapsed;

                    // Tampilkan Hari Kerja Bersih dengan format yang sudah diproses dari backend
                    document.getElementById('statClean').innerHTML = stats.cleanWorkDays;

                    document.getElementById('statShortfall').innerHTML = stats.shortfallDays;
                    document.getElementById('statAbsent').textContent = stats.absentDays;
                    document.getElementById('periodInfo').textContent = 'Periode: ' + stats.periodInfo;

                    // Logika tampilan kartu berdasarkan status terpenuhi atau belum
                    const cardRemaining = document.getElementById('cardRemaining');
                    const cardOvertime = document.getElementById('cardOvertime');

                    if (stats.isComplete) {
                        // Jika sudah terpenuhi: tampilkan Lembur Bersih, sembunyikan Sisa Jam
                        cardRemaining.style.display = 'none';
                        cardOvertime.style.display = 'block';
                        document.getElementById('statOvertime').textContent = stats.cleanOvertime;
                    } else {
                        // Jika belum terpenuhi: tampilkan Sisa Jam, sembunyikan Lembur Bersih
                        cardRemaining.style.display = 'block';
                        cardOvertime.style.display = 'none';
                        document.getElementById('statRemaining').textContent = stats.remainingHours;
                    }
                })
                .withFailureHandler(showError)
                .calculateWorkHours(currentEmployee, currentYear, currentMonth);
        }

        function formatDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
    </script>
</body>

</html>